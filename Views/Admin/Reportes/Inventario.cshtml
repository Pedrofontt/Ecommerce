@model List<EcommerceSystem.Models.Entities.Producto>
@{
    ViewData["Title"] = "Reporte de Inventario";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-boxes"></i> Reporte de Inventario</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a asp-action="ExportarInventarioCSV" 
           asp-route-busqueda="@ViewData["Busqueda"]" 
           asp-route-categoriaId="@ViewData["CategoriaId"]" 
           asp-route-soloStockBajo="@ViewData["SoloStockBajo"]" 
           class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Exportar a CSV
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form asp-action="Inventario" method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" name="busqueda" value="@ViewData["Busqueda"]" 
                       class="form-control" placeholder="Nombre o SKU del producto...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Categoría</label>
                <select name="categoriaId" class="form-select">
                    <option value="">Todas las categorías</option>
                    @{
                        var categoriaSeleccionada = ViewData["CategoriaId"]?.ToString();
                    }
                    @foreach (var cat in ViewBag.Categorias)
                    {
                        <option value="@cat.Id" selected="@(categoriaSeleccionada == cat.Id.ToString())">
                            @cat.Nombre
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Filtro</label>
                <div class="form-check form-switch">
                    <input type="checkbox" name="soloStockBajo" value="true" 
                           class="form-check-input" id="stockBajoCheck"
                           @(ViewData["SoloStockBajo"]?.ToString() == "True" ? "checked" : "")>
                    <label class="form-check-label" for="stockBajoCheck">
                        Solo productos con stock bajo
                    </label>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block w-100">
                    <i class="bi bi-search"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Estadísticas generales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cash-coin"></i> Valor Total Inventario</h5>
                <p class="card-text display-6">@ViewBag.ValorTotalInventario.ToString("C")</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-box-seam"></i> Total Productos</h5>
                <p class="card-text display-6">@ViewBag.ProductosTotales</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Stock Bajo</h5>
                <p class="card-text display-6">@ViewBag.ProductosStockBajo</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle"></i> Sin Stock</h5>
                <p class="card-text display-6">@ViewBag.ProductosSinStock</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de inventario -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5><i class="bi bi-list-ul"></i> Detalle de Inventario</h5>
    </div>
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Marca</th>
                            <th>Proveedor</th>
                            <th class="text-end">Stock</th>
                            <th class="text-end">Stock Mín.</th>
                            <th class="text-end">Precio Unit.</th>
                            <th class="text-end">Valor Total</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            var valorTotal = item.Stock * item.Precio;
                            var porcentajeStock = item.StockMinimo > 0 ? ((decimal)item.Stock / item.StockMinimo) * 100 : 100;
                            
                            <tr class="@(item.Stock == 0 ? "table-danger" : item.Stock <= item.StockMinimo ? "table-warning" : "")">
                                <td><code>@item.SKU</code></td>
                                <td>
                                    <strong>@item.Nombre</strong>
                                    @if (item.Destacado)
                                    {
                                        <span class="badge bg-warning text-dark ms-1">
                                            <i class="bi bi-star-fill"></i>
                                        </span>
                                    }
                                </td>
                                <td>@(item.Categoria?.Nombre ?? "N/A")</td>
                                <td>@(item.Marca?.Nombre ?? "N/A")</td>
                                <td>@(item.Proveedor?.Nombre ?? "N/A")</td>
                                <td class="text-end">
                                    @if (item.Stock == 0)
                                    {
                                        <span class="badge bg-danger">0</span>
                                    }
                                    else if (item.Stock <= item.StockMinimo)
                                    {
                                        <span class="badge bg-warning text-dark">@item.Stock</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@item.Stock</span>
                                    }
                                </td>
                                <td class="text-end">@item.StockMinimo</td>
                                <td class="text-end">@item.Precio.ToString("C")</td>
                                <td class="text-end"><strong>@valorTotal.ToString("C")</strong></td>
                                <td>
                                    @if (item.Stock == 0)
                                    {
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i> Sin Stock
                                        </span>
                                    }
                                    else if (porcentajeStock <= 25)
                                    {
                                        <span class="badge bg-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Crítico
                                        </span>
                                    }
                                    else if (porcentajeStock <= 50)
                                    {
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-exclamation-circle"></i> Bajo
                                        </span>
                                    }
                                    else if (porcentajeStock <= 100)
                                    {
                                        <span class="badge bg-info">
                                            <i class="bi bi-info-circle"></i> Atención
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Normal
                                        </span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-secondary fw-bold">
                            <td colspan="8" class="text-end">TOTAL VALORIZADO:</td>
                            <td class="text-end">@ViewBag.ValorTotalInventario.ToString("C")</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-3 text-center text-muted">
                <small>Mostrando @Model.Count productos</small>
            </div>
        }
        else
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No se encontraron productos con los filtros seleccionados.
            </div>
        }
    </div>
</div>

<!-- Leyenda -->
<div class="card mt-4 bg-light">
    <div class="card-body">
        <h6 class="card-title"><i class="bi bi-info-circle"></i> Leyenda de Estados</h6>
        <div class="row">
            <div class="col-md-3">
                <span class="badge bg-success">Normal</span> - Stock superior al 100% del mínimo
            </div>
            <div class="col-md-3">
                <span class="badge bg-info">Atención</span> - Stock entre 50% y 100% del mínimo
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning text-dark">Bajo</span> - Stock entre 25% y 50% del mínimo
            </div>
            <div class="col-md-3">
                <span class="badge bg-danger">Crítico</span> - Stock menor al 25% del mínimo o sin stock
            </div>
        </div>
    </div>
</div>
