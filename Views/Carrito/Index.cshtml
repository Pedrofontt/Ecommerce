@model EcommerceSystem.Models.Entities.Carrito

@{
    ViewData["Title"] = "Carrito de Compras";
}

<div class="container py-4">
    <h2 class="mb-4">
        <i class="bi bi-cart3"></i> Mi Carrito de Compras
    </h2>

    @if (Model != null && Model.Items != null && Model.Items.Any())
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Productos en el Carrito (@Model.Items.Count)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 100px;">Imagen</th>
                                        <th>Producto</th>
                                        <th style="width: 150px;">Precio</th>
                                        <th style="width: 150px;" class="text-center">Cantidad</th>
                                        <th style="width: 150px;" class="text-end">Subtotal</th>
                                        <th style="width: 80px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Items)
                                    {
                                        <tr>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.Producto.ImagenPrincipal))
                                                {
                                                    <img src="@item.Producto.ImagenPrincipal" alt="@item.Producto.Nombre" 
                                                         class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    <img src="/img/productos/default.jpg" alt="Sin imagen" 
                                                         class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                                }
                                            </td>
                                            <td class="align-middle">
                                                <a asp-controller="Tienda" asp-action="Producto" asp-route-id="@item.Producto.Id" 
                                                   class="text-decoration-none text-dark">
                                                    <strong>@item.Producto.Nombre</strong>
                                                </a>
                                                <br>
                                                <small class="text-muted">SKU: @item.Producto.SKU</small>
                                                @if (item.Producto.Stock < item.Cantidad)
                                                {
                                                    <br>
                                                    <small class="text-danger">
                                                        <i class="bi bi-exclamation-triangle"></i> 
                                                        Solo hay @item.Producto.Stock disponibles
                                                    </small>
                                                }
                                            </td>
                                            <td class="align-middle">
                                                <strong>@item.Producto.Precio.ToString("C")</strong>
                                            </td>
                                            <td class="align-middle">
                                                <form asp-action="ActualizarCantidad" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="itemId" value="@item.Id">
                                                    <div class="input-group input-group-sm">
                                                        <button type="submit" name="cantidad" value="@(item.Cantidad - 1)" 
                                                                class="btn btn-outline-secondary" 
                                                                @(item.Cantidad <= 1 ? "disabled" : "")>
                                                            <i class="bi bi-dash"></i>
                                                        </button>
                                                        <input type="number" name="cantidad" value="@item.Cantidad" 
                                                               class="form-control text-center" min="1" max="@item.Producto.Stock" 
                                                               style="width: 60px;" readonly>
                                                        <button type="submit" name="cantidad" value="@(item.Cantidad + 1)" 
                                                                class="btn btn-outline-secondary"
                                                                @(item.Cantidad >= item.Producto.Stock ? "disabled" : "")>
                                                            <i class="bi bi-plus"></i>
                                                        </button>
                                                    </div>
                                                </form>
                                            </td>
                                            <td class="align-middle text-end">
                                                <strong class="text-primary">
                                                    @((item.Producto.Precio * item.Cantidad).ToString("C"))
                                                </strong>
                                            </td>
                                            <td class="align-middle text-center">
                                                <form asp-action="Eliminar" method="post">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="itemId" value="@item.Id">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            onclick="return confirm('¿Eliminar este producto?')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between">
                            <a asp-controller="Tienda" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Seguir Comprando
                            </a>
                            <form asp-action="Vaciar" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-danger" 
                                        onclick="return confirm('¿Vaciar el carrito?')">
                                    <i class="bi bi-trash"></i> Vaciar Carrito
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen del Pedido -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var subtotal = Model.Items.Sum(i => i.Producto.Precio * i.Cantidad);
                            var impuesto = subtotal * 0.13m; // 13% IVA (ajusta según tu país)
                            var envio = subtotal >= 50 ? 0 : 5; // Envío gratis sobre $50
                            var total = subtotal + impuesto + envio;
                        }

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong>@subtotal.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Impuesto (13%):</span>
                            <strong>@impuesto.ToString("C")</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Envío:</span>
                            <strong>
                                @if (envio == 0)
                                {
                                    <span class="text-success">GRATIS</span>
                                }
                                else
                                {
                                    @envio.ToString("C")
                                }
                            </strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="mb-0">Total:</h5>
                            <h4 class="mb-0 text-primary">@total.ToString("C")</h4>
                        </div>

                        @if (envio > 0)
                        {
                            <div class="alert alert-info py-2">
                                <small>
                                    <i class="bi bi-info-circle"></i> 
                                    Envío gratis en compras mayores a $50
                                </small>
                            </div>
                        }

                        <div class="d-grid gap-2">
                            <a asp-action="Checkout" class="btn btn-primary btn-lg">
                                <i class="bi bi-credit-card"></i> Proceder al Pago
                            </a>
                        </div>

                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> Compra 100% Segura
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Cupón de Descuento (Opcional) -->
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <h6 class="card-title">¿Tienes un cupón?</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Código de cupón">
                            <button class="btn btn-outline-secondary" type="button" disabled>
                                Aplicar
                            </button>
                        </div>
                        <small class="text-muted">Función próximamente disponible</small>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Carrito Vacío -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                        <h3>Tu carrito está vacío</h3>
                        <p class="text-muted">Agrega productos para comenzar tu compra</p>
                        <a asp-controller="Tienda" asp-action="Index" class="btn btn-primary btn-lg mt-3">
                            <i class="bi bi-shop"></i> Ir a la Tienda
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>